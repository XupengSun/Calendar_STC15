

# 51单片机表

## TMOD定时器/计数器模式选择器(不可位寻址)timer mode 

<img src="https://gitee.com/sun-roc/picture/raw/master/img/image-20200519175122788.png" alt="image-20200519175122788" style="zoom:80%;" />

**C/T**：定时或计数方式选择位，当C/T=1时工作于计数方式；当C/T=0时工作于定时方式

**GATE**：门控位，用于控制定时/计数器的启动是否受外部中断请求信号的影响。

### 计数器工作方式

1. 13位: **X=8192-N**
2. 16位:**X=65536-N**
3. 8位自动: **X=256-N**,TH自动装载到TL
4. 两个8位:,仅定时器0变成两个8位寄存器.

### 定时器工作方式

fosc:晶振频率
单位：us   50ms=50000us   

1. 13位:计数值为N和初值X关系:**X=8192-N*fosc/12**
2. 16位:**X=65536-N*fosc/12**
3. 8位: **X=256-N*fosc/12**



## TCON定时/计数器的控制寄存器(可位寻址)timer control

| TCON  | D7   | D6   | D5   | D4   | D3   | D2   | D1   | D0   |
| ----- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| (88H) | TF1  | TR1  | TF0  | TR0  | IE1  | IT1  | IE0  | IT0  |

1. **判断是否溢出**TF0（1）：定时/计数器T0（1）的溢出标志位，当定时/计数器T1计满时，由硬件使它置位，如中断允许则触发T1中断。进入中断处理后由内部硬件电路自动清除。Timer0 flag
2. **启动定时器**  TR0（1）：定时/计数器T0（1）的启动位，可由软件置位或清零，当TR0（1）=1时启动；TR0（1）=0时停止。Timer0 Run
3. **外部中断形式**IT0（IT1）：外部中断0（或1）触发方式控制位。IT0（或IT1）被设置为0，电平触发方式；IT0（或IT1）被设置为1，边沿触发方式。 Interrupt1 type
4. **外部中断请求**IE0（IE1）：外部中断0（或1）的中断请求标志位。 (判断有无申请)Interrupt0 exterior



## IE 外部中断(可位寻址) interrupt enable

| IE    | D7   | D6   | D5   | D4   | D3   | D2   | D1   | D0   |
| ----- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| (A8H) | EA   |      | ET2  | ES   | ET1  | EX1  | ET0  | EX0  |

1. EA**总开关**：中断允许总控位。EA=0，屏蔽所有的中断请求；EA=1，开放中断。 

2. ET2：定时器/计数器T2的溢出中断允许位 
3. ET2：定时器/计数器T2的溢出中断允许位 
4. ES：**串行口**中断允许位。 
5. ET1：**定时器/计数器T1**的溢出中断允许位。 
6. EX1：外部中断 **INT1**的中断允许位。 
7. ET0：**定时器/计数器T10**的溢出中断允许位。 
8. EX0：外部中断 **INT0**的中断允许位。 



## IP中断优先级interrupt priority

| IP    | D7   | D6   | D5   | D4   | D3   | D2   | D1   | D0   |
| ----- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| (B8H) |      |      | PT2  | PS   | PT1  | PX1  | PT0  | PX0  |

1. PT2：定时器/计数器T2的中断优先级控制位，只用于52子系列。
2. PS：串行口的中断优先级控制位。
3. PT1：定时器/计数器T1的中断优先级控制位。 
4. PX1：外部中断INT1的中断优先级控制位。 
5. PT0：定时器/计数器T0的中断优先级控制位
6. PX0：外部中断INT0的中断优先级控制位



## 中断入口编号

| **中断源**          | **入口编号** |
| ------------------- | ------------ |
| **外部中断0(P3.2)** | **0**        |
| **定时/计数器2**    | **1**        |
| **外部中断1(P3.3)** | **2**        |
| **定时/计数器1**    | **3**        |
| **串行口**          | **4**        |



## UART串口通信

SCON: 
RI:Receive Interrupt   //串行口接收中断请求标志位 
TI:Transmit Interrupt   //串行口发送中断请求标志位 

### 串行口控制寄存器SCON(可位寻址)

| SCON | D7   | D6   | D5   | D4   | D3   | D2   | D1   | D0   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 98H  | SM0  | SM1  | SM2  | REN  | TB8  | RB8  | TI   | RI   |

1. 决定串口通信的模式:模式一最常用,**波特率只能T1产生**

| SM0  | SM1  | 方式  | 功能            | 波特率           |
| ---- | ---- | ----- | --------------- | ---------------- |
| 0    | 0    | 方式0 | 移位寄存器方式  | fosc/12          |
| 0    | 1    | 方式1 | 8位异步通信方式 | 可变             |
| 1    | 0    | 方式2 | 9位异步通信方式 | fosc/32或fosc/64 |
| 1    | 1    | 方式3 | 9位异步通信方式 | 可变             |

2. **SM2**：多机通信控制位。(极少用,模式1直接清零)

3. **REN**：允许接收控制位。当REN=1，则允许接收，当REN=0，则禁止接收。
4. **TB8**：发送数据的第9位。 (模式2,3中发送的第九位数据)
5. **RB8**：接收数据的第9位。 (模式2,3中发送的第九位数据)模式1中用于接收停止位
6. **TI**：发送中断标志位。 
7. **RI**：接收中断标志位。

### 基本步骤

1. 配置串口模式
2. 配置定时器T1为模式2,自动重装模式
3. 根据波特率计算TH1和TL1的初始值,有需要时可以使波特率加倍
4. 打开定时器控制器TR1,让定时器跑起来

### 一．方式0移位寄存器方式

方式0通常用来外接移位寄存器，用作扩展I/O口。
 RXD：串行数据        TXD：同步时钟。
 数据格式：低位在前，高位在后，长度8位，在SBUF中。
 波特率：fosc /12。

### 二．方式1 8位异步通信方式

    TXD：发送数据端      RXD：接收数据端。
数据格式： 1位起始位（0），SBUF中8位数据位（低位在前）和1位停止位（1）。
波特率： **2^SMOD×（T1的溢出率）/32**

**T1的初值=256 - fosc×2SMOD /（12×波特率×32）**

发送:

  条件：TI=0
  操作：SBUF=A
  结果：发送完毕，TI置“1”。

接收:

​	条件：RI=0，REN（SCON.4）置“1”。
​    结果：8位数据接收数据缓冲器SBUF中，同时，RI置“1” ，向CPU申请中断。 
​    用户处理：A=SBUF

	## 头文件

``` c
#ifndef _MAIN_H //.h文件中写,如果其他.c文件调用.h文件会先判断防止重复调用
#define _MAIN_H
extern xx(全局变量)//告诉你有这么回事,具体在哪去项目中有的文件去找
    //仅对存在在项目里的文件有效,与命名无关
void xx,(extern 相当于写道非main.c文件的.c文件中为了调用main.c文件的接口)
    //没用到的函数可以不声明,会自动调用
#ifndef _MAIN_C 
extern xx(全局变量)
#endif
#endif
    
    //一定要把文件添加到项目中呀!!!!,extern出去的数据不能赋值;
```

